

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Image Colorizer</title>
<style>
  :root{
    --bg:#0d1117;
    --panel:#0f1622;
    --text:#e6edf3;
    --radius:14px;
    --border:1px solid rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background: radial-gradient(80% 80% at 10% -10%, #0c1430 0%, var(--bg) 60%) fixed;
    font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }

  header{
    position:sticky; top:0; z-index:5;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 14px;
    background:linear-gradient(to bottom, rgba(10,14,22,.9), rgba(10,14,22,.55));
    backdrop-filter:saturate(140%) blur(10px);
    border-bottom:var(--border);
    font-weight:700;
  }
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  button{
    appearance:none; border:0; cursor:pointer;
    padding:10px 12px; border-radius:12px; color:var(--text);
    background:linear-gradient(180deg, #1b2331, #141b27); border:var(--border);
    transition:transform .14s ease, background .14s ease, opacity .14s ease;
  }
  button:hover{transform:translateY(-1px)}
  button.primary{background:linear-gradient(180deg, #6aa3ff, #4c8dff); color:#0b1020; font-weight:800}
  button.success{background:linear-gradient(180deg, #34d399, #10b981); color:#081d15; font-weight:800}
  button.danger{background:linear-gradient(180deg, #ff7e7e, #ff5d5d); color:#200909; font-weight:800}
  button.ghost{background:transparent}
  button:disabled{opacity:.55; cursor:not-allowed}

  .container{max-width:1240px; margin:0 auto; padding:14px}
  .grid{display:grid; gap:14px; grid-template-columns: 1.25fr .75fr}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .panel{
    background:linear-gradient(180deg, #0f1624, #0c1320);
    border:var(--border); border-radius:var(--radius); padding:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .panel-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
  .title{font-size:13px; color:#cdd6e5; font-weight:600}

  .dropzone{
    border-radius:var(--radius); border:1px dashed rgba(255,255,255,.13);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
    min-height:340px; padding:8px; position:relative; user-select:none;
  }
  .dz-msg{position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    color:#a4aebb; font-size:13px; pointer-events:none}
  .pair{display:grid; gap:10px; grid-template-columns:1fr 1fr}
  @media (max-width:900px){ .pair{grid-template-columns:1fr} }

  .canvas-wrap{border:var(--border); border-radius:12px; overflow:hidden; background:#0a0f16; display:flex; flex-direction:column}
  .canvas-head{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; font-size:12px; color:#c9d4e6; background:rgba(255,255,255,.03); border-bottom:var(--border)}
  /* True transparency preview */
  .checkerboard{
    background:
      linear-gradient(45deg, #9aa0ab22 25%, transparent 25%) 0 0/18px 18px,
      linear-gradient(-45deg, #9aa0ab22 25%, transparent 25%) 0 9px/18px 18px,
      linear-gradient(45deg, transparent 75%, #9aa0ab22 75%) 9px -9px/18px 18px,
      linear-gradient(-45deg, transparent 75%, #9aa0ab22 75%) -9px 0/18px 18px;
  }
  canvas{width:100%; height:auto; display:block; background:transparent}

  .ranges{display:flex; flex-direction:column; gap:10px; max-height:440px; overflow:auto; padding-right:4px}
  .range-row{
    display:grid; gap:8px; align-items:center;
    grid-template-columns: 48px 1fr 1fr 44px 36px;
    background:rgba(255,255,255,.03); border:var(--border); border-radius:12px; padding:10px;
  }
  .range-row small{color:#cfd6e6}
  .num{display:flex; flex-direction:column; gap:6px}
  .num label{font-size:11px; opacity:.7}
  input[type="number"]{
    width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:#0e1420; color:var(--text); outline:none; font-size:13px;
  }
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{appearance:none; margin:0}
  .swatch-btn{position:relative; height:38px; border-radius:10px; border:var(--border); padding:0; background:transparent; cursor:pointer}
  .checker{position:absolute; inset:0; background:
    linear-gradient(45deg, #9aa0ab22 25%, transparent 25%) 0 0/16px 16px,
    linear-gradient(-45deg, #9aa0ab22 25%, transparent 25%) 0 8px/16px 16px,
    linear-gradient(45deg, transparent 75%, #9aa0ab22 75%) 8px -8px/16px 16px,
    linear-gradient(-45deg, transparent 75%, #9aa0ab22 75%) -8px 0/16px 16px;}
  .swatch{position:absolute; inset:0; border-radius:10px}

  /* Picker */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:20px;
    background:rgba(5,8,12,.55); backdrop-filter:blur(8px); z-index:20; opacity:0; transition:opacity .12s ease}
  .modal.open{display:flex; opacity:1}
  .picker{
    width:min(760px, 96vw); display:grid; gap:16px; grid-template-columns: 1fr 320px;
    background:linear-gradient(180deg, #111827, #0d1520); border-radius:16px; padding:16px; border:var(--border);
    box-shadow:0 10px 30px rgba(0,0,0,.35)
  }
  @media (max-width:820px){ .picker{grid-template-columns:1fr} }

  .wheelwrap{position:relative; margin:auto; width:clamp(260px, 48vw, 520px); aspect-ratio:1; user-select:none; touch-action:none}
  canvas.hue{position:absolute; inset:0; display:block}
  .sv{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); border-radius:13px; box-shadow:0 10px 30px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); touch-action:none}
  .cursor, .h-cursor{position:absolute; pointer-events:none; border-radius:50%; border:2px solid #fff; box-shadow:0 0 0 3px rgba(0,0,0,.35), inset 0 0 0 2px #0003}
  .cursor{width:14px; height:14px}
  .h-cursor{width:16px; height:16px}

  .picker-controls{display:flex; flex-direction:column; gap:12px}
  .alpha-track{position:relative; height:14px; border-radius:999px; border:var(--border); overflow:hidden}
  .alpha-track::before{
    content:""; position:absolute; inset:0; background:
      linear-gradient(45deg, #9aa0ab22 25%, transparent 25%) 0 0/16px 16px,
      linear-gradient(-45deg, #9aa0ab22 25%, transparent 25%) 0 8px/16px 16px,
      linear-gradient(45deg, transparent 75%, #9aa0ab22 75%) 8px -8px/16px 16px,
      linear-gradient(-45deg, transparent 75%, #9aa0ab22 75%) -8px 0/16px 16px;
    filter:contrast(1.1)
  }
  .alpha-fill{position:absolute; inset:0}
  input[type="range"]{width:100%}
  .code{display:flex; gap:8px; flex-wrap:wrap}
  .chip{padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.08); background:#0b121e; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
  .picker-footer{display:flex; justify-content:flex-end; gap:8px}
</style>
</head>
<body>

<header>
  Image Colorizer
  <div class="actions">
    <button id="openBtn" class="primary">Open</button>
    <button id="pasteBtn" class="ghost">Paste</button>
    <button id="saveBtn" class="success" disabled>Save</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="panel">
      <div class="panel-head"><div class="title">Workspace</div><div id="origInfo" class="title" style="opacity:.7"></div></div>
      <div class="dropzone" id="dropzone">
        <div class="dz-msg" id="dzMsg">Drop / Click / Paste</div>
        <div class="pair" id="pair" style="display:none;">
          <div class="canvas-wrap">
            <div class="canvas-head"><b>Original</b></div>
            <canvas id="originalCanvas"></canvas>
          </div>
          <div class="canvas-wrap checkerboard">
            <div class="canvas-head"><b>Preview</b></div>
            <canvas id="processedCanvas"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div class="title">Ranges</div>
        <div style="display:flex; gap:8px">
          <button id="addRangeBtn">Add</button>
          <button id="resetRangesBtn" class="ghost">Redistribute</button>
        </div>
      </div>
      <div id="ranges" class="ranges"></div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" hidden />

<!-- Color Picker Modal -->
<div class="modal" id="pickerModal" aria-hidden="true">
  <div class="picker" role="dialog" aria-modal="true" aria-label="Color picker">
    <div class="wheelwrap" id="wheelwrap">
      <canvas id="hueCanvas" class="hue"></canvas>
      <canvas id="svCanvas" class="sv"></canvas>
      <div id="hCursor" class="h-cursor"></div>
      <div id="svCursor" class="cursor"></div>
    </div>
    <div class="picker-controls">
      <div class="alpha-track" id="alphaTrack"><div id="alphaFill" class="alpha-fill"></div></div>
      <input type="range" id="alphaRange" min="0" max="100" step="1" value="100" />
      <div class="code">
        <div id="rgbaCode" class="chip">rgba(255,0,0,1)</div>
        <div id="hexCode" class="chip">#FF0000FF</div>
      </div>
      <div class="picker-footer">
        <button id="cancelPick" class="ghost">Cancel</button>
        <button id="okPick" class="primary">Apply</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Helpers ---------- */
const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
const $=s=>document.querySelector(s);
function rgbToHex({r,g,b,a=255}){const h=n=>n.toString(16).padStart(2,'0').toUpperCase(); return `#${h(r)}${h(g)}${h(b)}${h(a)}`;}
function hsvToRgb(h,s,v){
  let c=v*s, x=c*(1-Math.abs((h/60)%2-1)), m=v-c, r=0,g=0,b=0;
  if(0<=h&&h<60){r=c;g=x}else if(60<=h&&h<120){r=x;g=c}
  else if(120<=h&&h<180){g=c;b=x}else if(180<=h&&h<240){g=x;b=c}
  else if(240<=h&&h<300){r=x;b=c}else{r=c;b=x}
  return {r:Math.round((r+m)*255), g:Math.round((g+m)*255), b:Math.round((b+m)*255)};
}
function rgbToHsv(r,g,b){
  r/=255; g/=255; b/=255; const max=Math.max(r,g,b), min=Math.min(r,g,b), d=max-min;
  let h=0, s=max?d/max:0, v=max;
  if(d){
    switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;}
    h*=60;
  }
  return {h,s,v};
}

/* ---------- App State ---------- */
let imageLoaded=false, imgW=0, imgH=0, grayData=null;
const originalCanvas=$('#originalCanvas'), processedCanvas=$('#processedCanvas');
const oCtx=originalCanvas.getContext('2d'), pCtx=processedCanvas.getContext('2d');

let ranges=[], rangeIdCounter=0;
let previewQueued=false;
function schedulePreview(){ if(previewQueued) return; previewQueued=true; requestAnimationFrame(()=>{ previewQueued=false; updatePreview(); }); }

/* ---------- Ranges ---------- */
const rangesEl=$('#ranges');
function addRange(defaults={}){
  const id=++rangeIdCounter;
  const row=document.createElement('div'); row.className='range-row'; row.dataset.id=id;
  const label=document.createElement('small'); label.textContent=`R${ranges.length+1}`;
  const minBox=document.createElement('div'); minBox.className='num';
  const maxBox=document.createElement('div'); maxBox.className='num';
  minBox.innerHTML=`<label>Min</label><input type="number" min="0" max="255" step="1" value="${defaults.min ?? 0}" id="min-${id}">`;
  maxBox.innerHTML=`<label>Max</label><input type="number" min="0" max="255" step="1" value="${defaults.max ?? 128}" id="max-${id}">`;
  const swatchBtn=document.createElement('button'); swatchBtn.className='swatch-btn'; swatchBtn.id=`swatch-${id}`;
  const checker=document.createElement('div'); checker.className='checker';
  const swatch=document.createElement('div'); swatch.className='swatch'; swatchBtn.appendChild(checker); swatchBtn.appendChild(swatch);
  const delBtn=document.createElement('button'); delBtn.className='danger'; delBtn.textContent='×'; delBtn.title='Remove';

  row.appendChild(label); row.appendChild(minBox); row.appendChild(maxBox); row.appendChild(swatchBtn); row.appendChild(delBtn);
  rangesEl.appendChild(row);

  const range={id, min:+minBox.querySelector('input').value, max:+maxBox.querySelector('input').value,
               color: defaults.color ?? {r:255,g:0,b:0,a:255}, row, swatch, label};
  ranges.push(range); setSwatch(range);

  function onChange(){
    range.min=clamp(parseInt(minBox.querySelector('input').value||'0'),0,255);
    range.max=clamp(parseInt(maxBox.querySelector('input').value||'0'),0,255);
    if(range.min>range.max){ range.max=range.min; maxBox.querySelector('input').value=range.max; }
    minBox.querySelector('input').value=range.min; maxBox.querySelector('input').value=range.max;
    schedulePreview();
  }
  minBox.querySelector('input').addEventListener('input', onChange);
  maxBox.querySelector('input').addEventListener('input', onChange);
  swatchBtn.addEventListener('click', ()=> openPickerFor(range));
  delBtn.addEventListener('click', ()=>{
    if(ranges.length<=1) return;
    row.remove(); ranges=ranges.filter(r=>r.id!==id);
    ranges.forEach((r,i)=> r.label.textContent=`R${i+1}`);
    schedulePreview();
  });
  ranges.forEach((r,i)=> r.label.textContent=`R${i+1}`);
}
function setSwatch(r){ const {r:cr,g:cg,b:cb,a}=r.color; r.swatch.style.background=`rgba(${cr},${cg},${cb},${(a/255).toFixed(3)})`; }
function redistributeRanges(){
  const n=ranges.length; if(!n) return; const step=Math.floor(256/n);
  for(let i=0;i<n;i++){
    const min=i*step, max=(i===n-1?255:((i+1)*step-1));
    const r=ranges[i]; r.min=min; r.max=max;
    r.row.querySelector(`#min-${r.id}`).value=min; r.row.querySelector(`#max-${r.id}`).value=max;
  }
  schedulePreview();
}

/* ---------- Loading ---------- */
function showWorkArea(show){
  $('#pair').style.display=show?'grid':'none';
  $('#dzMsg').style.display=show?'none':'flex';
  $('#saveBtn').disabled=!show;
}
async function loadImageFromFile(file){
  const dataUrl=await new Promise((res,rej)=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file);});
  await loadImageFromDataURL(dataUrl);
}
async function loadImageFromDataURL(dataUrl){
  const img=new Image();
  img.onload=()=>{
    imgW=img.naturalWidth; imgH=img.naturalHeight;
    originalCanvas.width=processedCanvas.width=imgW; originalCanvas.height=processedCanvas.height=imgH;
    oCtx.clearRect(0,0,imgW,imgH); oCtx.drawImage(img,0,0);
    const src=oCtx.getImageData(0,0,imgW,imgH).data;
    grayData=new Uint8ClampedArray(imgW*imgH);
    for(let i=0,j=0;i<src.length;i+=4,j++){ grayData[j]=Math.round(0.299*src[i]+0.587*src[i+1]+0.114*src[i+2]); }
    $('#origInfo').textContent=`${imgW}×${imgH}`;
    imageLoaded=true; showWorkArea(true); schedulePreview();
  };
  img.onerror=()=>alert('Could not load image.');
  img.src=dataUrl;
}

/* ---------- Processing ---------- */
function updatePreview(){
  if(!imageLoaded||!grayData) return;
  const LUT=new Uint8ClampedArray(256*4);
  for(const r of ranges){
    const {min,max,color:{r:cr,g:cg,b:cb,a:ca}}=r;
    for(let i=clamp(min,0,255); i<=clamp(max,0,255); i++){
      const k=i*4; LUT[k]=cr; LUT[k+1]=cg; LUT[k+2]=cb; LUT[k+3]=ca;
    }
  }
  const out=pCtx.createImageData(imgW,imgH), odata=out.data;
  for(let i=0;i<grayData.length;i++){ const k=grayData[i]*4, o=i*4; odata[o]=LUT[k]; odata[o+1]=LUT[k+1]; odata[o+2]=LUT[k+2]; odata[o+3]=LUT[k+3]; }
  pCtx.putImageData(out,0,0);
}

/* ---------- Picker (Canvas Hue Ring = exact match) ---------- */
const modal=$('#pickerModal');
const wheelwrap=$('#wheelwrap');
const hueCanvas=$('#hueCanvas'); const hueCtx=hueCanvas.getContext('2d');
const svCanvas=$('#svCanvas'); const svCtx=svCanvas.getContext('2d');
const hCursor=$('#hCursor'); const svCursor=$('#svCursor');
const alphaRange=$('#alphaRange'); const alphaFill=$('#alphaFill');
const rgbaCode=$('#rgbaCode'); const hexCode=$('#hexCode');

let pickState={h:0,s:1,v:1,a:1,forRange:null,size:0,thickness:28,innerRadius:0};

function drawHueRing(){
  const size=pickState.size, t=pickState.thickness;
  const dpr=window.devicePixelRatio||1;
  hueCanvas.width=Math.round(size*dpr); hueCanvas.height=Math.round(size*dpr);
  hueCanvas.style.width=hueCanvas.style.height=size+'px';
  hueCtx.setTransform(dpr,0,0,dpr,0,0);
  hueCtx.clearRect(0,0,size,size);
  hueCtx.lineWidth=t; hueCtx.lineCap='butt';
  const cx=size/2, cy=size/2, r=size/2 - t/2;
  // one stroke per degree for super-accurate match
  for(let deg=0; deg<360; deg++){
    const start=(deg-0.5)*Math.PI/180, end=(deg+0.5)*Math.PI/180;
    hueCtx.beginPath();
    hueCtx.strokeStyle=`hsl(${deg} 100% 50%)`;
    hueCtx.arc(cx,cy,r,start,end);
    hueCtx.stroke();
  }
}

function layoutPicker(){
  let size=Math.round(wheelwrap.clientWidth); if(size<80) size=360;
  const thickness=clamp(Math.round(size*0.11),18,42);
  pickState.size=size; pickState.thickness=thickness;

  drawHueRing();

  // SV square fits inside inner circle
  const innerR = size/2 - thickness - 6; pickState.innerRadius=innerR;
  const svSide = Math.max(40, Math.floor(innerR*Math.SQRT2*0.96));
  const dpr=window.devicePixelRatio||1;
  svCanvas.width=Math.round(svSide*dpr); svCanvas.height=Math.round(svSide*dpr);
  svCanvas.style.width = svCanvas.style.height = svSide+'px';
  svCtx.setTransform(dpr,0,0,dpr,0,0);
  renderSV(); updateHueCursor(); updateSVCursor(); updateAlphaVisuals();
}

function updateHueCursor(){
  const size=pickState.size, t=pickState.thickness;
  const r=size/2 - t/2 - 1;
  const theta=pickState.h*Math.PI/180;
  const cx=size/2 + r*Math.cos(theta), cy=size/2 + r*Math.sin(theta);
  hCursor.style.left=(cx-8)+'px'; hCursor.style.top=(cy-8)+'px';
}

function renderSV(){
  const side=parseInt(svCanvas.style.width);
  const base=hsvToRgb(pickState.h,1,1);
  svCtx.clearRect(0,0,side,side);
  svCtx.fillStyle=`rgb(${base.r},${base.g},${base.b})`; svCtx.fillRect(0,0,side,side);
  const g1=svCtx.createLinearGradient(0,0,side,0); g1.addColorStop(0,'#fff'); g1.addColorStop(1,'#fff0');
  svCtx.fillStyle=g1; svCtx.fillRect(0,0,side,side);
  const g2=svCtx.createLinearGradient(0,0,0,side); g2.addColorStop(0,'#0000'); g2.addColorStop(1,'#000');
  svCtx.fillStyle=g2; svCtx.fillRect(0,0,side,side);
}

function updateSVCursor(){
  const side=parseInt(svCanvas.style.width);
  const x=clamp(pickState.s*side,0,side), y=clamp((1-pickState.v)*side,0,side);
  const rect=svCanvas.getBoundingClientRect(), parent=svCanvas.parentElement.getBoundingClientRect();
  svCursor.style.left=(rect.left-parent.left + x - 7)+'px';
  svCursor.style.top =(rect.top -parent.top  + y - 7)+'px';
}

function updateAlphaVisuals(){
  const rgb=hsvToRgb(pickState.h,pickState.s,pickState.v), a=pickState.a;
  rgbaCode.textContent=`rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${a.toFixed(2)})`;
  hexCode.textContent=rgbToHex({r:rgb.r,g:rgb.g,b:rgb.b,a:Math.round(a*255)});
  alphaFill.style.background=`linear-gradient(90deg, rgba(${rgb.r},${rgb.g},${rgb.b},0), rgba(${rgb.r},${rgb.g},${rgb.b},1))`;
}

function openPickerFor(range){
  pickState.forRange=range;
  const {r,g,b,a}=range.color; const hsv=rgbToHsv(r,g,b);
  pickState.h=hsv.h; pickState.s=hsv.s; pickState.v=hsv.v; pickState.a=a/255;
  alphaRange.value=Math.round(pickState.a*100);

  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
  requestAnimationFrame(()=> layoutPicker()); // ensure visible before measuring
}
function closePicker(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
function commitPicker(){
  if(!pickState.forRange) return;
  const rgb=hsvToRgb(pickState.h,pickState.s,pickState.v);
  pickState.forRange.color={r:rgb.r,g:rgb.g,b:rgb.b,a:Math.round(pickState.a*255)};
  setSwatch(pickState.forRange); schedulePreview(); closePicker();
}

/* Exact hue mapping from pointer angle -> same ring pixels */
let draggingHue=false, draggingSV=false;
function hueFromEvent(e){
  const rect=hueCanvas.getBoundingClientRect();
  const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
  const dx=e.clientX-cx, dy=e.clientY-cy;
  // DOM y increases downward; atan2 gives 0 at +x (right) and increases clockwise – matches our ring drawing.
  pickState.h=(Math.atan2(dy, dx)*180/Math.PI + 360)%360;
  updateHueCursor(); renderSV(); updateAlphaVisuals();
}
hueCanvas.addEventListener('pointerdown', e=>{ draggingHue=true; hueCanvas.setPointerCapture(e.pointerId); hueFromEvent(e); });
hueCanvas.addEventListener('pointermove',  e=>{ if(draggingHue) hueFromEvent(e); });
hueCanvas.addEventListener('pointerup',    e=>{ draggingHue=false; try{ hueCanvas.releasePointerCapture(e.pointerId);}catch{} });

function setSVFromEvent(e){
  const rect=svCanvas.getBoundingClientRect();
  const x=clamp(e.clientX-rect.left,0,rect.width), y=clamp(e.clientY-rect.top,0,rect.height);
  pickState.s=x/rect.width; pickState.v=1 - y/rect.height;
  updateSVCursor(); updateAlphaVisuals();
}
svCanvas.addEventListener('pointerdown', e=>{ draggingSV=true; svCanvas.setPointerCapture(e.pointerId); setSVFromEvent(e); });
svCanvas.addEventListener('pointermove', e=>{ if(draggingSV) setSVFromEvent(e); });
svCanvas.addEventListener('pointerup',   e=>{ draggingSV=false; try{ svCanvas.releasePointerCapture(e.pointerId);}catch{} });

alphaRange.addEventListener('input', ()=>{ pickState.a=alphaRange.value/100; updateAlphaVisuals(); });
$('#cancelPick').addEventListener('click', closePicker);
$('#okPick').addEventListener('click', commitPicker);
modal.addEventListener('click', e=>{ if(e.target===modal) closePicker(); });
window.addEventListener('resize', ()=>{ if(modal.classList.contains('open')) layoutPicker(); });

/* ---------- Controls ---------- */
const fileInput=$('#fileInput');
$('#openBtn').addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(f) loadImageFromFile(f); fileInput.value=''; });

const dropzone=$('#dropzone');
dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.style.borderColor='rgba(106,163,255,.9)'; });
dropzone.addEventListener('dragleave', ()=> dropzone.style.borderColor='rgba(255,255,255,.13)');
dropzone.addEventListener('drop', e=>{ e.preventDefault(); dropzone.style.borderColor='rgba(255,255,255,.13)'; const f=e.dataTransfer.files?.[0]; if(f) loadImageFromFile(f); });
dropzone.addEventListener('click', ()=> fileInput.click());

$('#pasteBtn').addEventListener('click', async ()=>{
  try{
    const items=await navigator.clipboard.read();
    for(const item of items){ for(const type of item.types){ if(type.startsWith('image/')){ const blob=await item.getType(type); loadImageFromFile(blob); return; } } }
    alert('No image on clipboard.');
  }catch{ alert('Clipboard permission denied/unsupported.'); }
});

$('#saveBtn').addEventListener('click', ()=>{
  if(!imageLoaded) return;
  processedCanvas.toBlob(blob=>{
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`colorized_${new Date().toISOString().replace(/[:.]/g,'-')}.png`; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
  }, 'image/png');
});

$('#addRangeBtn').addEventListener('click', ()=>{ addRange(); redistributeRanges(); });
$('#resetRangesBtn').addEventListener('click', redistributeRanges);
document.addEventListener('keydown', e=>{ if(e.key==='Escape'&&modal.classList.contains('open')) closePicker(); });

/* ---------- Defaults ---------- */
const palette=[ {r:255,g:59,b:48,a:255},{r:52,g:199,b:89,a:255},{r:0,g:122,b:255,a:255},{r:255,g:149,b:0,a:255} ];
addRange({min:0,max:127,color:palette[0]});
addRange({min:128,max:255,color:palette[1]});
redistributeRanges();
</script>
</body>
</html>
